<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Viaje</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Solicitar Viaje</h1>
        <input id="origin" type="text" placeholder="Origen">
        <input id="destination" type="text" placeholder="Destino">
        <div id="map"></div>
        <p id="distance"></p>
        <p id="fareAuto"></p>
        <p id="fareMoto"></p>
        <button id="confirmButton" disabled onclick="confirmRide()">Confirmar Viaje</button>
    </div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUHs9GkMFd5CC9HkwZdQRe8okW6WqA8K0&libraries=places&callback=initMap"></script>
    <script>
        let map, originMarker, destinationMarker, directionsService, directionsRenderer, geocoder;

        function initMap() {
            const santoTome = { lat: -29.9961, lng: -59.2217 };

            map = new google.maps.Map(document.getElementById('map'), {
                center: santoTome,
                zoom: 12,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true,
            });
            geocoder = new google.maps.Geocoder();

            const inputOrigin = document.getElementById('origin');
            const inputDestination = document.getElementById('destination');
            const autocompleteOrigin = new google.maps.places.Autocomplete(inputOrigin);
            const autocompleteDestination = new google.maps.places.Autocomplete(inputDestination);

            autocompleteOrigin.setFields(['place_id', 'geometry', 'formatted_address']);
            autocompleteDestination.setFields(['place_id', 'geometry', 'formatted_address']);

            autocompleteOrigin.addListener('place_changed', () => {
                const place = autocompleteOrigin.getPlace();
                if (place.geometry) {
                    updateOriginMarker(place.geometry.location);
                    map.setCenter(place.geometry.location);
                }
            });

            autocompleteDestination.addListener('place_changed', () => {
                const place = autocompleteDestination.getPlace();
                if (place.geometry) {
                    updateDestinationMarker(place.geometry.location);
                    map.setCenter(place.geometry.location);
                }
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLocation = new google.maps.LatLng(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    updateOriginMarker(userLocation);
                    map.setCenter(userLocation);
                });
            }

            function updateOriginMarker(location) {
                if (originMarker) {
                    originMarker.setPosition(location);
                } else {
                    originMarker = new google.maps.Marker({
                        position: location,
                        map: map,
                        draggable: true,
                        title: "Origen",
                    });
                    originMarker.addListener('dragend', () => {
                        updateAutocompleteAddress('origin', originMarker.getPosition());
                        calculateRoute();
                    });
                }
                updateAutocompleteAddress('origin', location);
                calculateRoute();
            }

            function updateDestinationMarker(location) {
                if (destinationMarker) {
                    destinationMarker.setPosition(location);
                } else {
                    destinationMarker = new google.maps.Marker({
                        position: location,
                        map: map,
                        draggable: true,
                        title: "Destino",
                    });
                    destinationMarker.addListener('dragend', () => {
                        updateAutocompleteAddress('destination', destinationMarker.getPosition());
                        calculateRoute();
                    });
                }
                updateAutocompleteAddress('destination', location);
                calculateRoute();
            }

            map.addListener('click', function(event) {
                if (!destinationMarker) {
                    updateDestinationMarker(event.latLng);
                } else {
                    destinationMarker.setPosition(event.latLng);
                }
            });

            function updateAutocompleteAddress(type, location) {
                geocoder.geocode({ location: location }, (results, status) => {
                    if (status === google.maps.GeocoderStatus.OK && results[0]) {
                        if (type === 'origin') {
                            document.getElementById('origin').value = results[0].formatted_address;
                        } else if (type === 'destination') {
                            document.getElementById('destination').value = results[0].formatted_address;
                        }
                    }
                });
            }

            function calculateRoute() {
                if (originMarker && destinationMarker) {
                    const request = {
                        origin: originMarker.getPosition(),
                        destination: destinationMarker.getPosition(),
                        travelMode: google.maps.TravelMode.DRIVING,
                    };
                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(result);
                            calculateDistanceAndFare(result);
                        }
                    });
                }
            }

            function calculateDistanceAndFare(result) {
                const distance = result.routes[0].legs[0].distance.text;
                const duration = result.routes[0].legs[0].duration.text;
                document.getElementById('distance').textContent = `Distancia: ${distance} (${duration})`;

                const distanceInKm = parseFloat(distance.replace(/[^\d.-]/g, ''));

                const fareAuto = distanceInKm * 1000;
                const fareMoto = distanceInKm * 500;

                document.getElementById('fareAuto').textContent = `Tarifa Auto: $${fareAuto.toFixed(2)}`;
                document.getElementById('fareMoto').textContent = `Tarifa Moto: $${fareMoto.toFixed(2)}`;
                
                document.getElementById('confirmButton').disabled = false;
            }
        }

        function confirmRide() {
            alert("Viaje confirmado!");
        }
    </script>
</body>
</html>
